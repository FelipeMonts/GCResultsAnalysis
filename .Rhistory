##############################################################################################################
#
#
#   Statistical Analysis of Soil Gas Flux Measurements From The Strategic Tillage Experiment
#
#
#                              Felipe Montes 09/80/2023
#
#
#
###############################################################################################################
###############################################################################################################
#                             Tell the program where the package libraries are stored
###############################################################################################################
.libPaths("C:\\Users\\frm10\\AppData\\Local\\R\\win-library\\4.2")  ;
###############################################################################################################
#                            Install the packages that are needed
###############################################################################################################
# install.packages("openxlsx",  dependencies = T)
# install.packages("Rtools",  dependencies = T)
# install.packages("pdftools",  dependencies = T)
# install.packages("askpass",  dependencies = T)
# install.packages("cli",  dependencies = T)
# install.packages("utf8",  dependencies = T)
# install.packages("quantreg",  dependencies = T)
# install.packages("HMR",  dependencies = T)
# install.packages("DescTools", dependencies = T)
###############################################################################################################
#                           load the libraries that are needed
###############################################################################################################
library(openxlsx)
library(lattice)
library(pdftools)
library(stringr)
library(quantreg)
library(HMR)
library(DescTools)
###############################################################################################################
#                             Setting up working directory  Loading Packages and Setting up working directory
###############################################################################################################
#      set the working directory
# readClipboard()
setwd("D:\\Felipe\\Current_Projects\\CCC Based Experiments\\StrategicTillage_NitrogenLosses_OrganicCoverCrops\\DataAnalysis\\RCode\\GCResultsAnalysis")
###############################################################################################################
#                           Select the N2O Sampling year
###############################################################################################################
# Year = 2021
# Year = 2022
###############################################################################################################
#                           Select the Gas
###############################################################################################################
# Gas = "CO2"
#
Gas = "N2O"
#
# Gas = "CH4"
###############################################################################################################
#                           load the working data from GCANalysis
###############################################################################################################
Year = 2021
Name.2021 <- paste0(Gas, ".Flux." , Year) ;
assign(x = paste0(Gas, ".Flux." , Year) , value = read.csv(file = paste0("FluxDataAnalysisResults\\" , Gas, "_Mass.Flux.Data_" , Year, ".csv")))
str(get(Name.2021))
head(get(Name.2021))
get(Name.2021)[get(Name.2021)$Warning == "Data error" ,]
Year = 2022
Name.2022 <- paste0(Gas, ".Flux." , Year) ;
assign(x = paste0(Gas, ".Flux." , Year) , value = read.csv(file = paste0("FluxDataAnalysisResults\\" , Gas, "_Mass.Flux.Data_" , Year, ".csv")))
str(get(Name.2022))
head(get(Name.2022))
get(Name.2022)[get(Name.2022)$Warning == "Data error" ,]
#which(! names(N2O.Flux.2021) %in% names(N2O.Flux.2022 )
###############################################################################################################
#                           Merge the data from 2021 and 2022
###############################################################################################################
Gas.Emissions <- rbind(get(Name.2021), get(Name.2022))    ;
names(get(Name.2021))
names(get(Name.2022))
names(get(Name.2022))[which(!names(get(Name.2022)) %in% names(get(Name.2021)))]
str(Gas.Emissions )
head(Gas.Emissions)
Gas.Emissions[Gas.Emissions$Warning == "Data error" ,]
###############################################################################################################
#                           Create year as a factor form the sampling date
###############################################################################################################
Gas.Emissions$Sampling.Date <- as.Date(Gas.Emissions$Sampling.Date)  ;
Gas.Emissions$Sampling.Month <- as.factor(format(as.Date(Gas.Emissions$Sampling.Date), format = "%B")) ;
Gas.Emissions$Sampling.DayofYear <- as.numeric(format(as.Date(Gas.Emissions$Sampling.Date), format = "%j")) ;
Gas.Emissions$Sampling.Year <- as.numeric(format(as.Date(Gas.Emissions$Sampling.Date), format = "%Y")) ;
###############################################################################################################
#                          Summarize the data using DescTools Package
###############################################################################################################
Desc(Gas.Emissions$Warning, plotit = T)
Desc(Gas.Emissions$Prefilter, plotit = T)
Desc(Gas.Emissions$f0.KgSubstance.Ha.day, plotit = T)
Desc(Gas.Emissions$LR.f0.KgSubstance.Ha.day, plotit = T)
Desc.Date <- Desc(Gas.Emissions$Sampling.Date, plotit = T, maxrows = 100)
Desc(Gas.Emissions)
# write.csv( x = Gas.Emissions ,
#
#            file = paste0("FluxDataAnalysisResults\\" , Gas, "_StatisticalAnalysis" , ".csv") , row.names = F ) ;
#
###############################################################################################################
#                          Statistical analysis using LR cumulative emissions
###############################################################################################################
str(Gas.Emissions )
head(Gas.Emissions)
names( Gas.Emissions )
Cumm.Emm.Analysis.1  <- Gas.Emissions[ , c("Sampling.Date" , "BLOCK.F" , "CoverCrop.F" ,
"Treatment.F" , "Total.Cum.Emissions" ,
"Incre.Cum.Emissions" , "Period.Emissions",
"Month.Emissions", "Sampling.Month" , "Sampling.Year")] ;
########## convert the variables to factors ########
Cumm.Emm.Analysis.1[,c("Sampling.Year" ,"BLOCK.F" , "CoverCrop.F" , "Treatment.F" )] <-
lapply(Cumm.Emm.Analysis.1[,c("Sampling.Year" ,"BLOCK.F" , "CoverCrop.F" , "Treatment.F" )], factor) ;
str(Cumm.Emm.Analysis.1)
unique(Cumm.Emm.Analysis.1[, c("Sampling.Year" ,"BLOCK.F" , "CoverCrop.F" ,
"Treatment.F" , "Total.Cum.Emissions")]) ;
Cumm.Emm.Analysis.2 <- unique(Cumm.Emm.Analysis.1[, c("Sampling.Year" ,"BLOCK.F" , "CoverCrop.F" ,
"Treatment.F" , "Total.Cum.Emissions")]) ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F , groups = Sampling.Year  , horiz = F,
auto.key = T,data = Cumm.Emm.Analysis.2, stack =T)
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F * CoverCrop.F , groups = Sampling.Year  , horiz = F,
auto.key = list( space = "top" , columns = 2, title = "Year", points = F , rectangles = T),
data = Cumm.Emm.Analysis.2, stack = T, col = c("red" , "blue"), xlab = "Treatment",
ylab = "Cummulative N2O Emmisions kg/ha", main = "N2O Cummulative Emmisions" ,
panel=function(x,y,...){  panel.grid(h=-1, v=0); panel.barchart(x,y,...) } ,
par.settings = list(superpose.polygon=list( col = c("red" , "blue"))   ,
strip.background=list(col= "white"),
strip.border=list(col="black")))
Cumm.Stat.Anal <- lm(Total.Cum.Emissions ~ BLOCK.F + Sampling.Year + CoverCrop.F +  Treatment.F,
data = Cumm.Emm.Analysis.2)       ;
summary(Cumm.Stat.Anal)
anova(Cumm.Stat.Anal)
###### with interactions ###
Cumm.Stat.Anal <- lm(Total.Cum.Emissions ~ Sampling.Year + Sampling.Year* BLOCK.F +  BLOCK.F * CoverCrop.F *  Treatment.F,
data = Cumm.Emm.Analysis.2)
summary(Cumm.Stat.Anal)
anova(Cumm.Stat.Anal)
str(Cumm.Emm.Analysis.2)
# write.csv(anova(Cumm.Stat.Anal), file = "ANOVA_Table_Cum_N2O.csv", row.names = T)
### Calculating treatment Averages ###########
# https://stackoverflow.com/questions/11562656/calculate-the-mean-by-group#11562850#
tapply(Cumm.Emm.Analysis.2$Total.Cum.Emissions , Cumm.Emm.Analysis.2$BLOCK.F, mean)
aggregate(Total.Cum.Emissions ~ BLOCK.F , data = Cumm.Emm.Analysis.2, FUN = mean )
Cumm.N2O.Avg.Block <- aggregate(Total.Cum.Emissions ~ BLOCK.F , data = Cumm.Emm.Analysis.2, FUN = mean ) ;
Cumm.N2O.Avg.CoverCrop <- aggregate(Total.Cum.Emissions ~  CoverCrop.F  , data = Cumm.Emm.Analysis.2, FUN = mean ) ;
Cumm.N2O.Avg.Year <- aggregate(Total.Cum.Emissions ~  Sampling.Year  , data = Cumm.Emm.Analysis.2, FUN = mean ) ;
Cumm.N2O.Avg.Treat <- aggregate(Total.Cum.Emissions ~  Treatment.F  , data = Cumm.Emm.Analysis.2, FUN = mean ) ;
str(Cumm.N2O.Avg)
Cumm.Emm.Analysis.2.Order <- Cumm.Emm.Analysis.2[order(Cumm.Emm.Analysis.2$Total.Cum.Emissions, decreasing = T),]
str(Cumm.Emm.Analysis.2.Order)
##### Plotting the emissions by order of magnitude ####
Default.mar <- par("mar");
par(mar = c(9 , 4.1 ,  4.1,  2.1))
Cumm.Emm.Analysis.2.Order.2021 <- Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == "2021" ,] ;
barplot( height = Cumm.Emm.Analysis.2.Order.2021$Total.Cum.Emissions ,
names.arg = paste0("B:" , Cumm.Emm.Analysis.2.Order.2021$BLOCK.F ,"-C:", Cumm.Emm.Analysis.2.Order.2021$CoverCrop.F,
"-T:" , Cumm.Emm.Analysis.2.Order.2021$Treatment.F) ,las=2, main = "Emissions measured in 2021") ;
Cumm.Emm.Analysis.2.Order.2022 <- Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == "2022" ,] ;
barplot( height = Cumm.Emm.Analysis.2.Order.2022$Total.Cum.Emissions ,
names.arg = paste0("B:" , Cumm.Emm.Analysis.2.Order.2022$BLOCK.F ,"-CC:", Cumm.Emm.Analysis.2.Order.2022$CoverCrop.F,
"ST:" , Cumm.Emm.Analysis.2.Order.2022$Treatment.F) ,las=2, main = "Emissions measured in 2022")
str(Cumm.Emm.Analysis.2)
Cumm.Emm.Analysis.2$Log.Emm <- log(Cumm.Emm.Analysis.2$Total.Cum.Emissions) ;
Cumm.Emm.Analysis.2
Cumm.Emm.Analysis.2$Log.Emm <- log(Cumm.Emm.Analysis.2$Total.Cum.Emissions+1) ;
s
str(Cumm.Emm.Analysis.2.Order)
Cumm.Emm.Analysis.2.Order$Log.Emm <- log(Cumm.Emm.Analysis.2.Order$Total.Cum.Emissions+1) ;
str(Cumm.Emm.Analysis.2.Order)
Cumm.Emm.Analysis.2.Order$Log.Emm <- log(Cumm.Emm.Analysis.2.Order$Total.Cum.Emissions+1) ;
barplot( height = Cumm.Emm.Analysis.2.Order$Log.Emm,
names.arg = paste0("B:" , Cumm.Emm.Analysis.2.Order.2021$BLOCK.F ,"-C:", Cumm.Emm.Analysis.2.Order.2021$CoverCrop.F,
"-T:" , Cumm.Emm.Analysis.2.Order.2021$Treatment.F) ,las=2, main = "Log Cummulative Emissions ") ;
barplot( height = Cumm.Emm.Analysis.2.Order$Log.Emm,
names.arg = paste0("B:" , Cumm.Emm.Analysis.2.Order$BLOCK.F ,"-C:", Cumm.Emm.Analysis.2.Order$CoverCrop.F,
"-T:" , Cumm.Emm.Analysis.2.Order$Treatment.F) ,las=2, main = "Log Cummulative Emissions ") ;
Cumm.Stat.Anal.Log <- lm(Log.Emm ~ BLOCK.F + Sampling.Year + CoverCrop.F +  Treatment.F,
data = Cumm.Emm.Analysis.2.Order)       ;
summary(Cumm.Stat.Anal)
summary(Cumm.Stat.Anal.Log)
anova(Cumm.Stat.Anal.Log)
Cumm.Stat.Anal.Log <- lm(Log.Emm ~ BLOCK.F + Sampling.Year + CoverCrop.F +  Treatment.F,
data = Cumm.Emm.Analysis.2.Order)       ;
summary(Cumm.Stat.Anal.Log)
anova(Cumm.Stat.Anal.Log)
summary(Cumm.Stat.Anal.Log.int)
Cumm.Stat.Anal.Log.int<- lm(Log.Emm ~ Sampling.Year + Sampling.Year* BLOCK.F +  BLOCK.F * CoverCrop.F *  Treatment.F,
data = Cumm.Emm.Analysis.2)
Cumm.Stat.Anal.Log.int<- lm(Log.Emm ~ Sampling.Year + Sampling.Year* BLOCK.F +  BLOCK.F * CoverCrop.F *  Treatment.F,
data = Cumm.Emm.Analysis.2.Order)   ;
summary(Cumm.Stat.Anal.Log.int)
anova(Cumm.Stat.Anal.Log.int)
plot(Cumm.Stat.Anal.Log$residuals,Cumm.Emm.Analysis.2.Order$Log.Emm )
plot(Cumm.Stat.Anal.Log)
plot(Cumm.Stat.Anal)
barchart(~Total.Cum.Emissions     , groups = c("BLOCK.F" , "CoverCrop.F" , "Treatment.F") , data = Cumm.Emm.Analysis.2.Order.2021 , stack = F )
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F , groups = Sampling.Year  , horiz = F,
auto.key = T,data = Cumm.Emm.Analysis.2, stack =T)
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F * CoverCrop.F , groups = Sampling.Year  , horiz = F,
auto.key = list( space = "top" , columns = 2, title = "Year", points = F , rectangles = T),
data = Cumm.Emm.Analysis.2, stack = T, col = c("red" , "blue"), xlab = "Treatment",
ylab = "Cummulative N2O Emmisions kg/ha", main = "N2O Cummulative Emmisions" ,
panel=function(x,y,...){  panel.grid(h=-1, v=0); panel.barchart(x,y,...) } ,
par.settings = list(superpose.polygon=list( col = c("red" , "blue"))   ,
strip.background=list(col= "white"),
strip.border=list(col="black")))
barchart(Total.Cum.Emissions ~ BLOCK.F + CoverCrop.F + Treatment.F , data = Cumm.Emm.Analysis.2.Order.2021 , stack = F )
barchart(~ Total.Cum.Emissions | BLOCK.F + CoverCrop.F + Treatment.F , data = Cumm.Emm.Analysis.2.Order.2021 , stack = F )
barchart(~ Total.Cum.Emissions | BLOCK.F + CoverCrop.F + Treatment.F , data = Cumm.Emm.Analysis.2.Order.2021 , stack = F , horiz = F)
barchart(Total.Cum.Emissions ~ Treatment. | BLOCK.F + CoverCrop.F + YEAR , data = Cumm.Emm.Analysis.2.Order.2021 , stack = F , horiz = F)
barchart(Total.Cum.Emissions ~ Treatment. | BLOCK.F + CoverCrop.F + Year , data = Cumm.Emm.Analysis.2.Order.2021 , stack = F , horiz = F)
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F + Year , data = Cumm.Emm.Analysis.2.Order.2021 , stack = F , horiz = F)
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F + Year , data = Cumm.Emm.Analysis.2.Order , stack = F , horiz = F)
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , data = Cumm.Emm.Analysis.2.Order , stack = F , horiz = F)
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021] , stack = F , horiz = F) ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021,] , stack = F , horiz = F) ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2021" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021,] , stack = F , horiz = F) ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2021" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021,] , stack = F , horiz = F ,
ylab = "Cumulative N2O emissions kg N2O-N / ha year") ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2021" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021,] , stack = F , horiz = F ,
ylab = "Cumulative N2O emissions kg N2O-N / ha year" , xlab = "Smart Tillage Treatment") ;
str(Cumm.Emm.Analysis.2.Order$BLOCK.F)
levels(Cumm.Emm.Analysis.2.Order$BLOCK.F) <- c("Block 1" , "Block 2" , "Block 3" , "Block 4" ) ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2021" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021,] , stack = F , horiz = F ,
ylab = "Cumulative N2O emissions kg N2O-N / ha year" , xlab = "Smart Tillage Treatment") ;
levels(Cumm.Emm.Analysis.2.Order$CoverCrop.F)
levels(Cumm.Emm.Analysis.2.Order$CoverCrop.F) <- c("Mixture" , "Clover" , "Triticale") ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2021" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021,] , stack = F , horiz = F ,
ylab = "Cumulative N2O emissions kg N2O-N / ha year" , xlab = "Smart Tillage Treatment", col = "red") ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2021" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021,] , stack = F , horiz = F ,
ylab = "Cumulative N2O emissions kg N2O-N / ha year" , xlab = "Smart Tillage Treatment", col = "red") ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2022" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2022,] , stack = F , horiz = F ,
ylab = "Cumulative N2O emissions kg N2O-N / ha year" , xlab = "Smart Tillage Treatment", col = "bllue") ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2022" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2022,] , stack = F , horiz = F ,
ylab = "Cumulative N2O emissions kg N2O-N / ha year" , xlab = "Smart Tillage Treatment", col = "bllue") ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2022" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2022,] , stack = F , horiz = F ,
ylab = "Cumulative N2O emissions kg N2O-N / ha year" , xlab = "Smart Tillage Treatment", col = "blue") ;
expression(u, 2, u + 0:9)
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2021" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021,] , stack = F , horiz = F ,
ylab = expression("Cumulative N[2]O emissions kg N[2]O-N  ha^-1 year^-1") , xlab = "Smart Tillage Treatment", col = "red") ;
plot(1:10, xlab=expression('hi'[5]*'there'[6]^8*'you'[2]))
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2021" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2021,] , stack = F , horiz = F ,
ylab = expression("Cumulative N"[2]*"O emissions kg N"[2]*"O-N  ha"^-1* "year"^-1) , xlab = "Smart Tillage Treatment", col = "red") ;
barchart(Total.Cum.Emissions ~ Treatment.F | BLOCK.F + CoverCrop.F , main = "Cumulative Emissions 2022" ,
data = Cumm.Emm.Analysis.2.Order[Cumm.Emm.Analysis.2.Order$Sampling.Year == 2022,] , stack = F , horiz = F ,
ylab = expression("Cumulative N"[2]*"O emissions kg N"[2]*"O-N  ha"^-1* "year"^-1) , xlab = "Smart Tillage Treatment", col = "blue") ;
